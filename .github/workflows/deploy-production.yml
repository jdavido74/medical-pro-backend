# =============================================================================
# MedicalPro Backend - Production Deployment Workflow
# =============================================================================
# Deploys backend API to production server on push to master branch
#
# Required GitHub Secrets:
#   - PROD_HOST: Production server IP or hostname
#   - PROD_SSH_KEY: SSH private key for deploy user (ed25519)
#   - PROD_SSH_PORT: SSH port (default: 2222)
#
# Optional Secrets:
#   - SLACK_WEBHOOK_URL: For deployment notifications
# =============================================================================

name: Deploy Backend to Production

on:
  push:
    branches:
      - master
    paths:
      - 'src/**'
      - 'migrations/**'
      - 'package.json'
      - 'package-lock.json'
      - 'server.js'
      - '.github/workflows/deploy-production.yml'
  workflow_dispatch:
    inputs:
      run_migrations:
        description: 'Run database migrations'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '18'
  DEPLOY_PATH: '/var/www/medical-pro-backend'

jobs:
  # ===========================================================================
  # Job 1: Run Tests
  # ===========================================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test -- --passWithNoTests --watchAll=false
        env:
          NODE_ENV: test

  # ===========================================================================
  # Job 2: Deploy to Production
  # ===========================================================================
  deploy:
    name: Deploy to Production
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    environment:
      name: production
      url: https://app.medimaestro.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PROD_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ secrets.PROD_SSH_PORT || 2222 }} -H ${{ secrets.PROD_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Deploy Backend
        env:
          SSH_HOST: ${{ secrets.PROD_HOST }}
          SSH_PORT: ${{ secrets.PROD_SSH_PORT || 2222 }}
          RUN_MIGRATIONS: ${{ github.event.inputs.run_migrations || 'false' }}
        run: |
          ssh -i ~/.ssh/deploy_key -p $SSH_PORT deploy@$SSH_HOST << 'ENDSSH'
            set -e

            echo "ðŸš€ Starting deployment..."
            cd ${{ env.DEPLOY_PATH }}

            # Pull latest changes
            echo "ðŸ“¥ Pulling latest changes..."
            git fetch origin master
            git reset --hard origin/master

            # Install dependencies
            echo "ðŸ“¦ Installing dependencies..."
            npm ci --production

            # Run migrations if requested
            if [ "${{ env.RUN_MIGRATIONS }}" == "true" ]; then
              echo "ðŸ—„ï¸ Running database migrations..."
              npm run migrate || true
            fi

            # Graceful restart with PM2
            echo "ðŸ”„ Restarting application..."
            sudo pm2 reload medical-pro-backend --update-env

            # Verify deployment
            echo "âœ… Verifying deployment..."
            sleep 5
            curl -sf http://localhost:3001/api/v1/health || exit 1

            echo "âœ… Deployment completed successfully!"
          ENDSSH

      - name: Cleanup SSH
        if: always()
        run: rm -f ~/.ssh/deploy_key

      - name: Notify Success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const message = `
            ## âœ… Backend Deployment Successful

            **Branch:** \`master\`
            **Commit:** \`${{ github.sha }}\`
            **Author:** @${{ github.actor }}
            **Environment:** Production

            [View Commit](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            `;

            // Create deployment status
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: message
            });

      - name: Notify Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `## âŒ Backend Deployment Failed\n\nCheck the [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.`
            });

  # ===========================================================================
  # Job 3: Run Migrations (Optional)
  # ===========================================================================
  migrate:
    name: Run Migrations
    needs: deploy
    runs-on: ubuntu-latest
    if: github.event.inputs.run_migrations == 'true'

    steps:
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PROD_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ secrets.PROD_SSH_PORT || 2222 }} -H ${{ secrets.PROD_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Run Migrations
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ secrets.PROD_SSH_PORT || 2222 }} deploy@${{ secrets.PROD_HOST }} << 'ENDSSH'
            cd ${{ env.DEPLOY_PATH }}
            echo "ðŸ—„ï¸ Running database migrations..."
            npm run migrate
            echo "âœ… Migrations completed!"
          ENDSSH

      - name: Cleanup SSH
        if: always()
        run: rm -f ~/.ssh/deploy_key
